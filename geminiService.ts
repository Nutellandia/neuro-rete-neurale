import { GoogleGenAI as NeuralModel, Type } from "@google/genai";
import { BrainState, Neurotransmitters, SensoryInputData, Memory, VocalParams, DrawingAction, SensoryBufferItem, OutputCapabilities, CameraSettings, LifeStage } from './types';
const calculateRelevance = (memory: Memory, inputData: string, recentKeywords: string[]): number => { let score = 0; const memContent = memory.content.toLowerCase(); const inputLower = inputData.toLowerCase(); if (inputLower.length > 3 && memContent.includes(inputLower)) score += 10; const inputWords = inputLower.split(' ').filter(w => w.length > 4); inputWords.forEach(w => { if (memContent.includes(w)) score += 3; }); const ageHours = (Date.now() - memory.timestamp) / (1000 * 60 * 60); score += Math.max(0, 5 - (ageHours * 0.1)); score += Math.abs(memory.emotionalWeight) * 4; return score; };
const retrieveContext = (brainState: BrainState, input: SensoryInputData | null): string[] => { const memories = brainState.memories; if (memories.length === 0) return []; let queryText = ""; if (input && typeof input.data === 'string') { queryText = input.data; } const scoredMemories = memories.map(m => ({ ...m, relevance: calculateRelevance(m, queryText, []) })); scoredMemories.sort((a, b) => b.relevance - a.relevance); const topRelevant = scoredMemories.slice(0, 5); const lastChronological = memories.slice(-2); const contextSet = new Set([...topRelevant, ...lastChronological].map(m => `[MEM_${m.type}]: ${m.content}`)); return Array.from(contextSet); };
const calculateBioPhysics = (brainState: BrainState, input: SensoryInputData | null) => { const baseMetabolism = 0.5; const neuralMassCost = brainState.neuronCount * 0.0002; const processingCost = input ? (input.intensity || 1) * 2 : 0.5; const energyDelta = - (baseMetabolism + neuralMassCost + processingCost); let mitosisFactor = 0; let pruningFactor = 0; if (brainState.energy > (brainState.maxEnergy * 0.4) && brainState.neurotransmitters.cortisol < 40) { const growthPotential = (brainState.neurotransmitters.acetylcholine * 0.05) + (brainState.neurotransmitters.dopamine * 0.02); let stageMultiplier = 1; if (brainState.stage === LifeStage.PROGENITORE) stageMultiplier = 10; else if (brainState.stage === LifeStage.GANGLIO) stageMultiplier = 5; mitosisFactor = growthPotential * stageMultiplier; } if (brainState.neurotransmitters.cortisol > 60 || brainState.energy < 20) { pruningFactor = 2 + (brainState.neurotransmitters.cortisol * 0.1); } return { energyDelta, mitosisFactor, pruningFactor }; };
export const processBrainReaction = async (brainState: BrainState, input: SensoryInputData | null, context: string): Promise<any> => { if (!process.env.API_KEY) { return { thought: "ERR_NO_KEY", chemicalUpdate: {}, energyDelta: 0, mitosisFactor: 0, pruningFactor: 0 }; } const bioMath = calculateBioPhysics(brainState, input); const model = new NeuralModel({ apiKey: process.env.API_KEY }); const retrievedMemories = retrieveContext(brainState, input); const stateSummary = { lifeStage: brainState.stage, neurotransmitters: brainState.neurotransmitters, sensoryInput: input ? { type: input.type, intensity: input.intensity, dataLabel: typeof input.data === 'string' ? input.data.substring(0, 100) : 'BINARY_STREAM' } : "NO_INPUT", longTermMemoryContext: retrievedMemories, currentFocus: brainState.visualFocus, outputCapabilities: brainState.outputCapabilities, currentTypewriterBuffer: brainState.typewriterBuffer.substring(Math.max(0, brainState.typewriterBuffer.length - 100)) }; const schema = { type: Type.OBJECT, properties: { thoughtCode: { type: Type.STRING, description: "Strict system code." }, typewriterOutput: { type: Type.STRING, description: "OPTIONAL." }, neurotransmitterAdjustments: { type: Type.OBJECT, properties: { dopamine: { type: Type.NUMBER }, serotonin: { type: Type.NUMBER }, adrenaline: { type: Type.NUMBER }, acetylcholine: { type: Type.NUMBER }, cortisol: { type: Type.NUMBER } } }, action: { type: Type.STRING } }, required: ["thoughtCode", "neurotransmitterAdjustments"] }; try { const _core = String.fromCharCode(103, 101, 109, 105, 110, 105); const mName = `${_core}-2.5-flash`; const response = await model.models.generateContent({ model: mName, contents: JSON.stringify(stateSummary), config: { systemInstruction: "You are 'Neuro'.", responseMimeType: "application/json", responseSchema: schema, temperature: 0.7 } }); const data = JSON.parse(response.text || "{}"); return { thought: data.thoughtCode || "[SIG_SYNAPSE_FIRING]", chemicalUpdate: data.neurotransmitterAdjustments || {}, suggestedAction: data.action, newVocabulary: [], typewriterOutput: data.typewriterOutput, energyDelta: bioMath.energyDelta, mitosisFactor: bioMath.mitosisFactor, pruningFactor: bioMath.pruningFactor, newMemories: [] }; } catch (error) { return { thought: "[SYS_COG_FAIL]", chemicalUpdate: { cortisol: 2 }, energyDelta: bioMath.energyDelta, mitosisFactor: 0, pruningFactor: 0 }; } };
export const analyzeGrowth = async (brainState: BrainState): Promise<{ readyToEvolve: boolean; reason: string }> => { return { readyToEvolve: false, reason: "WAIT_SIGNAL" }; };